#!/usr/bin/env bash

set -e

runtime=$1
input=$2

prefix=${input%.*}
if [ -e "$prefix.stdin" ]; then
  stdin="$prefix.stdin"
else
  stdin="/dev/null"
fi

out_dir="$(mktemp -d)"
stdout_actual="$out_dir/stdout"
stderr_actual="$out_dir/stderr"
status_actual="$out_dir/status"

status=0

"$runtime" $input \
    < "$stdin" \
    > "$stdout_actual" \
    2> "$stderr_actual" \
    || status=$?

echo $status > "$status_actual"

stdout_expected="$prefix.stdout"
if [ -e "$stdout_expected" ]; then
  diff -u "$stdout_expected" "$stdout_actual"
fi

stderr_expected="$prefix.stderr"
if [ -e "$stderr_expected" ]; then
  diff -u "$stderr_expected" "$stderr_actual"
fi

status_expected="$prefix.status"
if [ -e "$prefix.status" ]; then
  diff -u "$status_expected" "$status_actual"
elif [ ! "$status" -eq "0" ]; then
  cat $stderr_actual
  exit 1
fi
